groups:
- name: kittyhawk
  rules:
  # Alert when one or more filecoin containers are down
  - alert: containerDownAlert
    expr: (count by (instance_name) (time() - container_last_seen{image=~"657871693752.dkr.ecr.us-east-1.amazonaws.com/filecoin:.*", instance_name=~".+"} < 31) OR vector(0)) < 5
    for: 1m
    labels:
      severity: page
    annotations:
      summary: "{{ $labels.value }} filecoin nodes on {{ $labels.instance_name }} down"
      description: "{{ $labels.value }} filecoin nodes on instance:{{ $labels.instance_name }} have been down for >1 minute."

  # Alert for any filecoin node that has restarted in the past 2 minutes
  - alert: containerRestartAlert
    expr: (container_start_time_seconds{image=~"657871693752.dkr.ecr.us-east-1.amazonaws.com/filecoin:.*"}) > (time() - 120)
    for: 1m
    labels:
      severity: page
    annotations:
      summary: "filecoin node:{{ $labels.name }} on instance:{{ $labels.instance_name }} restarted"
      description: "filecoin node:{{ $labels.name }} on instance:{{ $labels.instance_name }} has restarted over the past 2 minutes."

  # Alert for any instance that has < 15% free memory
  - alert: nodeFreeMemoryAlert
    expr: (((node_memory_MemFree_bytes + node_memory_Cached_bytes) /node_memory_MemTotal_bytes) * 100) < 15
    for: 5m
    labels:
      severity: page
    annotations:
      summary: "Instance {{ $labels.instance }} running out of memory"
      description: "{{ $labels.instance }} of job {{ $labels.job }} has been using > 85% memory  for more than 5 minutes."


  # Alert for any instance that uses > 90% CPU
  - alert: nodeCpuUsageAlert
    expr: node_load1  / on(instance) machine_cpu_cores > 0.9
    for: 5m
    labels:
      severity: page
    annotations:
      summary: "Instance {{ $labels.instance }} high CPU usage"
      description: "{{ $labels.instance }} of job {{ $labels.job }} has been using > 90% CPU for more than 5 minutes."


  # Alert for any instance that uses > 80% disk space
  - alert: nodeDiskUsageAlert
    expr: node_filesystem_free_bytes{mountpoint="/etc/hostname"} /  node_filesystem_size_bytes{mountpoint="/etc/hostname"} < 0.2
    for: 5m
    labels:
      severity: page
    annotations:
      summary: "Instance {{ $labels.instance }} high root disk usage"
      description: "{{ $labels.instance }} of job {{ $labels.job }} has been using > 80% disk space for more than 5 minutes."

  # Alert for any instance that uses > 80% inodes
  - alert: nodeDiskInodeUsageAlert
    expr: node_filesystem_files_free / node_filesystem_files{mountpoint="/etc/hostname"} < 0.2
    for: 5m
    labels:
      severity: page
    annotations:
      summary: "Instance {{ $labels.instance }} high root inode usage"
      description: "{{ $labels.instance }} of job {{ $labels.job }} has been using > 80% disk inodes for more than 5 minutes."

  # Alert if any node is in 'dispute' for more than 3 min
  - alert: nodeInDisputeAlert
    expr: nodes_in_dispute > 0
    for: 3m
    labels:
      severity: page
    annotations:
      summary: "One or more Filecoin nodes in dispute."
      description: "One or more Filecoin nodes has been in dispute for over 3 minuets."

  # Alert if the cluster has not mined a block in 1 min
  - alert: noBlockMined
    expr: (time() - last_block_time) > 60
    for: 0
    labels:
      severity: page
    annotations:
      summary: "Cluster on instance:{{ $labels.instance_name }} has not mined a block in over 1 minuet."
      description: "The filecoin cluster running on instance:{{ $labels.instance_name }} has not mined a new block in over 1 minuet."
